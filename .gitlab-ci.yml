image: docker:latest

services:
  - docker:dind

variables:
  # Optimisation Docker
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  # On d√©finit le r√©seau explicitement pour √©viter les conflits
  COMPOSE_PROJECT_NAME: oncostream-ci

stages:
  - test_and_validate

before_script:
  - apk add --no-cache docker-compose bash # On ajoute bash pour √™tre s√ªr
  - docker info
  - docker-compose --version

# --- UN SEUL JOB POUR TOUT G√âRER ---
full_pipeline:
  stage: test_and_validate
  script:
    # 1. CONSTRUCTION ET D√âMARRAGE
    - echo "üèóÔ∏è Construction et D√©marrage de l'infrastructure..."
    # On force le build ici pour √™tre s√ªr que les images existent dans ce job
    - docker-compose --profile bonus up -d --build

    # 2. ATTENTE
    - echo "‚è≥ Attente de la stabilisation des services (45s)..."
    - sleep 45
    - docker ps -a # Affiche l'√©tat pour d√©bugger si besoin

    # 3. INITIALISATION HBASE
    - echo "üõ†Ô∏è Initialisation de la table HBase..."
    # On utilise le script que tu as pr√©par√©
    - docker exec -i hbase hbase shell < hbase-config/init-script.txt

    # 4. TEST DU PRODUCER
    - echo "üß¨ Lancement du test Producer..."
    # On utilise le r√©seau du docker-compose (d√©fini par COMPOSE_PROJECT_NAME)
    - docker run --network oncostream-ci_oncostream-net --env KAFKA_BOOTSTRAP_SERVERS=kafka:29092 oncostream-producer --duration 10

    # 5. V√âRIFICATION FINALE (Correction du <<< ici)
    - echo "‚úÖ V√©rification des donn√©es dans HBase..."
    # Utilisation de 'echo |' au lieu de '<<<' pour compatibilit√© Linux Alpine
    - echo "scan 'oncostream_realtime'" | docker exec -i hbase hbase shell | grep "row(s)"

  after_script:
    - echo "üßπ Nettoyage..."
    - docker-compose --profile bonus down