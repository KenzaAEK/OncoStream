image: docker:latest

services:
  - docker:dind

stages:
  - build
  - test

variables:
  # Optimisation Docker pour Ã©viter de tout retÃ©lÃ©charger Ã  chaque fois
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

before_script:
  # On installe docker-compose car l'image de base ne l'a pas toujours
  - apk add --no-cache docker-compose
  # On se connecte au registre (si besoin plus tard, pour l'instant optionnel)
  - docker info
  - docker-compose --version

# --- Ã‰TAPE 1 : CONSTRUCTION ---
build_images:
  stage: build
  script:
    - echo "ğŸ—ï¸ Construction des images Docker..."
    - docker-compose --profile bonus build
  # On garde les images en cache pour l'Ã©tape suivante (optionnel mais plus rapide)
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - Dockerfile
        - docker-compose.yml
        - "**/*.py"
        - "**/*.scala"

# --- Ã‰TAPE 2 : TESTS D'INTÃ‰GRATION ---
test_pipeline:
  stage: test
  script:
    - echo "ğŸš€ DÃ©marrage de l'environnement complet..."
    - docker-compose --profile bonus up -d

    - echo "â³ Attente de la stabilisation des services (30s)..."
    - sleep 30

    - echo "ğŸ› ï¸ Initialisation de la table HBase..."
    - docker exec -i hbase hbase shell < hbase-config/init-script.txt

    - echo "ğŸ§¬ Lancement du test Producer (GÃ©nÃ©ration de donnÃ©es)..."
    # On lance le producer en mode test (durÃ©e limitÃ©e 10s)
    - docker run --network oncostream-net --env KAFKA_BOOTSTRAP_SERVERS=kafka:29092 oncostream-producer --duration 10

    - echo "âœ… VÃ©rification que HBase a reÃ§u des donnÃ©es..."
    # On scanne la table. Si elle est vide ou n'existe pas, le grep Ã©chouera
    - docker exec -i hbase hbase shell <<< "scan 'oncostream_realtime'" | grep "row(s)"

  after_script:
    - echo "ğŸ§¹ Nettoyage de l'environnement..."
    - docker-compose --profile bonus down