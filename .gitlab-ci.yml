image: docker:24.0.5 

services:
  - docker:24.0.5-dind

variables:
  # Optimisation Docker (Driver overlay2 est plus rapide)
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  COMPOSE_PROJECT_NAME: oncostream-ci
  # D√©finition explicite du r√©seau pour √©viter les erreurs de nommage
  NETWORK_NAME: "${COMPOSE_PROJECT_NAME}_default"

stages:
  - test_and_validate

# Optimisation: Cache pour apk si on garde l'installation manuelle (optionnel mais utile)
cache:
  paths:
    - /var/cache/apk

before_script:
  # Installation silencieuse (-q) pour garder les logs propres
  - apk add --no-cache docker-compose bash curl

full_integration_test:
  stage: test_and_validate
  script:
    # 1. CONSTRUCTION ET D√âMARRAGE
    - echo "üèóÔ∏è Construction et D√©marrage de l'infrastructure..."
    - docker-compose --profile bonus up -d --build

    # 2. ATTENTE INTELLIGENTE (Remplacement du sleep 45)
    - echo "Waiting for HBase to be ready..."
    # Boucle de 60 secondes max qui tente de lister les tables
    - |
      for i in $(seq 1 30); do
        if echo "list" | docker exec -i hbase hbase shell > /dev/null 2>&1; then
          echo "‚úÖ HBase is ready!"
          break
        fi
        echo "‚è≥ Still waiting for HBase... ($i/30)"
        sleep 2
      done

    # 3. INITIALISATION HBASE
    - echo "üõ†Ô∏è Initialisation de la table HBase..."
    - docker exec -i hbase hbase shell < hbase-config/init-script.txt

    # 4. DEBUG R√âSEAU (Au cas o√π le nom du r√©seau change)
    - docker network ls 
    
    # 5. TEST DU PRODUCER
    - echo "üß¨ Lancement du test Producer..."
    # Utilisation dynamique du r√©seau. Note: V√©rifie si ton docker-compose nomme le r√©seau "default" ou "oncostream-net"
    # Si ton docker-compose a un r√©seau nomm√© "oncostream-net", change la variable NETWORK_NAME ci-dessous manuellement.
    - docker run --network ${COMPOSE_PROJECT_NAME}_oncostream-net --env KAFKA_BOOTSTRAP_SERVERS=kafka:29092 oncostream-producer --duration 10

    # 6. V√âRIFICATION FINALE
    - echo "‚úÖ V√©rification des donn√©es dans HBase..."
    # Ta correction "echo |" est excellente pour Alpine/Ash
    - RESULT=$(echo "scan 'oncostream_realtime'" | docker exec -i hbase hbase shell)
    - echo "$RESULT"
    # On fait √©chouer le job si "row(s)" n'est pas trouv√© (grep -q retourne 0 si trouv√©, 1 sinon)
    - echo "$RESULT" | grep -q "row(s)" || (echo "‚ùå Aucune donn√©e trouv√©e dans HBase !" && exit 1)

  after_script:
    - echo "üßπ Nettoyage..."
    # Le down -v supprime aussi les volumes pour un nettoyage complet (propre pour le CI)
    - docker-compose --profile bonus down -v